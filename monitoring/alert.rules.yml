groups:
  - name: ApiAlerts
    rules:
      # --- ALERTA DE ERROS (PERCENTUAL) ---
      # Dispara um AVISO se mais de 2% das requisições nos últimos 10 minutos resultarem em erro 5xx.
      - alert: ApiHighWarningErrorRate
        expr: (sum(rate(http_requests_total{job="colibri-api", status_code=~"5.."}[10m])) by (job) / sum(rate(http_requests_total{job="colibri-api"}[10m])) by (job)) * 100 > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "API com taxa de erros elevada ({{ $labels.job }})"
          description: "A taxa de erros 5xx está acima de 2% nos últimos 10 minutos. Valor atual: {{ $value | printf \"%.2f\" }}%."

      # Dispara um alerta CRÍTICO se mais de 5% das requisições nos últimos 5 minutos resultarem em erro 5xx.
      - alert: ApiHighCriticalErrorRate
        expr: (sum(rate(http_requests_total{job="colibri-api", status_code=~"5.."}[5m])) by (job) / sum(rate(http_requests_total{job="colibri-api"}[5m])) by (job)) * 100 > 5
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "API com taxa de erros CRÍTICA ({{ $labels.job }})"
          description: "A taxa de erros 5xx ultrapassou 5% nos últimos 5 minutos! Valor atual: {{ $value | printf \"%.2f\" }}%."

      # --- ALERTA DE LATÊNCIA (DOIS NÍVEIS) ---
      # Dispara um AVISO se a latência p95 for maior que 750ms.
      - alert: ApiHighWarningLatency
        expr: histogram_quantile(0.95, sum(rate(http_requests_duration_seconds_bucket{job="colibri-api"}[5m])) by (le, job)) > 0.75
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Latência da API está alta ({{ $labels.job }})"
          description: "A latência p95 da API está acima de 750ms. Valor atual: {{ $value | printf \"%.2f\" }}s."

      # Dispara um alerta CRÍTICO se a latência p95 for maior que 1.5 segundos.
      - alert: ApiHighCriticalLatency
        expr: histogram_quantile(0.95, sum(rate(http_requests_duration_seconds_bucket{job="colibri-api"}[5m])) by (le, job)) > 1.5
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Latência da API está CRÍTICA ({{ $labels.job }})"
          description: "A latência p95 da API ultrapassou 1.5 segundos! Valor atual: {{ $value | printf \"%.2f\" }}s."

  - name: RedisAlerts
    rules:
      # --- ALERTA DE MEMÓRIA DO REDIS (DOIS NÍVEIS) ---
      # AVISO quando o uso de memória ultrapassa 85%.
      - alert: RedisHighMemoryUsageWarning
        expr: (redis_memory_used_bytes{job="redis_exporter"} / redis_memory_max_bytes{job="redis_exporter"}) * 100 > 85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Uso de memória do Redis está alto"
          description: "O Redis está usando mais de 85% da sua memória alocada. Uso atual: {{ $value | printf \"%.2f\" }}%."

      # CRÍTICO quando o uso de memória ultrapassa 95%.
      - alert: RedisHighMemoryUsageCritical
        expr: (redis_memory_used_bytes{job="redis_exporter"} / redis_memory_max_bytes{job="redis_exporter"}) * 100 > 95
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Uso de memória do Redis está CRÍTICO"
          description: "O Redis está usando mais de 95% da sua memória alocada! Ação imediata pode ser necessária. Uso atual: {{ $value | printf \"%.2f\" }}%."